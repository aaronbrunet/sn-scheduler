<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller=function(spUtil,$scope, snAttachmentHandler, $element) {
  /* widget controller */
  var c = this;

  spUtil.recordWatch($scope, $scope.data.constants.TABLE_SHIFTS, "rotation=" + $scope.data.rotation.id, function(record){
	console.log(record);
			spUtil.update($scope);//.then(function(){});
   });

var table = document.getElementById('readonly_table');
table.innerHTML = $scope.data.table_html;

// var mk = document.getElementById('markdown_table');
// mk.innerHTML = $scope.data.mk_table;

//TODO: Figure out if this is necessary
$scope.generateImg = function(id){
	//console.log('clicked button with id '+id);
	var parent = document.getElementById(id);
	console.log(parent);
	var result = document.getElementById('result');
	parent.style.display = "block";
	var table = document.getElementById('rotation-table-readonly');
			domtoimage.toPng(table)
				.then(function (dataUrl) {

					var link = document.createElement('a');
					link.download = $scope.data.rotation.rotation+'-schedule.png';
					link.href = dataUrl;
					link.click();

			// console.log(dataUrl);
			// 		var img = new Image();
			// 		img.src = dataUrl;
			// 		result.innerHTML = '<a id="screenshot" style="display:none" href="'+dataUrl+'">Save Screenshot</a>';
			// 		var link = document.getElementById('screenshot');
			// 		link.click();
					parent.style.display = "none";
				})
				.catch(function (error) {
					console.error('oops, something went wrong!', error);
				});
	};

	$scope.uploadImg = function(file){
		//var file = files.files[0];
		console.log([c.data.constants.TABLE_ROTATIONS,rotation,file]);
		
		snAttachmentHandler.create(c.data.constants.TABLE_ROTATIONS, c.data.rotation.id).uploadAttachment(file, {
			sysparm_fieldname: "image"
		}).then(function(response) {
			console.log('Uploaded!');
		});
	}

};]]></client_script>
        <controller_as>c</controller_as>
        <css>.schedule-body {&#13;
  margin: 2rem 0;&#13;
  padding: 2rem 0;&#13;
  &#13;
  display: flex;&#13;
  flex-direction: column;&#13;
  align-items: center;&#13;
  &#13;
  &amp;&gt;*{&#13;
  	min-width: 50rem;&#13;
  }&#13;
  &#13;
  .schedule-row {&#13;
  	margin: 1rem 0;&#13;
    display: flex;&#13;
    flex-direction: row;&#13;
  }&#13;
  &#13;
table {&#13;
	border: 1px solid grey;&#13;
  	padding: 2rem;&#13;
  	background-color: white;&#13;
	white-space: nowrap;&#13;
} &#13;
tr {&#13;
	padding: 1rem;&#13;
}&#13;
td,th {&#13;
	border: 1px solid grey;&#13;
  padding: 1rem 2rem;&#13;
  width: 33%;&#13;
}&#13;
&#13;
th, .holiday-row {&#13;
	background-color: #e2f5ff;&#13;
}&#13;
&#13;
tr.team-row {&#13;
  th { background-color: #ffd289; }&#13;
}&#13;
tr.title-row {&#13;
  th,td { background-color: #fff08f; }&#13;
}&#13;
tr.manager-row{&#13;
  th { background-color:#a2d0e9; }&#13;
  td { background-color:#e2f5ff; }&#13;
}&#13;
}&#13;
&#13;
#readonly_table {&#13;
	display:none;&#13;
	position: absolute;&#13;
    width: 100%;&#13;
    top: -500px;&#13;
}&#13;
&#13;
#markdown_table {&#13;
	width: 50rem;&#13;
}&#13;
&#13;
@media screen and (max-width:992px){&#13;
	.schedule-body {&#13;
	    &amp;&gt; * {&#13;
	 		width: auto;&#13;
    		min-width: auto;&#13;
  		}&#13;
      table {&#13;
      	white-space: normal;&#13;
      }&#13;
  	}&#13;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>on-call-schedule-week</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>On Call Schedule - Week</name>
        <option_schema>[{"displayValue":"On-Call Rotation","name":"rotation","section":"Data","label":"Rotation","type":"reference","value":"x_snc_on_call_sc_0_on_call_rotation","ed":{"reference":"x_snc_on_call_sc_0_on_call_rotation"}},{"name":"title","section":"Presentation","label":"Title","type":"string"}]</option_schema>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
  /* populate the 'data' object */
  /* e.g., data.table = $sp.getValue('table'); */
	var ocu = new x_snc_on_call_sc_0.OnCallUtils();
	var constants = ocu.getConstants();
	data.constants = constants;

	data.options = options;
	console.log(data.options);

	data.is_manager = true;

	data.admin_errors = [];

	var rotation = new GlideRecord(constants.TABLE_ROTATIONS);
	if(input && input?.rotation !=''){
		console.log(['input',input.rotation]);
		rotation.get(input.rotation.id);
	} else if(options?.rotation) {
		console.log(['options',options?.rotation]);
		rotation.get(options?.rotation);
	} else if($sp.getParameter('sys_id')) {
		console.log(['url',$sp.getParameter('sys_id')]);
		rotation.get($sp.getParameter('sys_id'));
	} else {
		rotation.get(ocu.getRotation());
	}
	data.rotation = {
		id:rotation.getUniqueValue(),
		rotation:rotation.getDisplayValue('rotation'),
		from:rotation.getDisplayValue('from'),
		to:rotation.getDisplayValue('to')
	};
	if(data.rotation?.rotation){
		var table_html = ocu.getReadonlyTable(rotation.getUniqueValue());
		data.table_html = table_html;
		data.mk_table = ocu.getMarkdownTable(rotation.getUniqueValue());
		console.log(data.mk_table);
		
		var managers = ocu.getManagersByRotation(rotation.getUniqueValue());
		for(let i in managers) {
			managers[i].shiftForm = $sp.getForm(constants.TABLE_SHIFTS, managers[i].shift_id);
			managers[i].shiftModel = managers[i].shiftForm._fields;
			managers[i].userForm = $sp.getForm('sys_user',managers[i].user);
			managers[i].userModel = managers[i].userForm._fields;
		}

		data.us_manager = managers.find(m => m.region == 'US');
		data.idc_manager = managers.find(m => m.region == 'IDC');
		if(!data.us_manager){data.admin_errors.push({error:'manager',msg:'No US Manager found'});}
		if(!data.idc_manager){data.admin_errors.push({error:'manager',msg:'No IDC Manager found'});}


		var now_manager = ocu.getManagersByDate();

		var holidays = ocu.getAllHolidaysForRotation(rotation.getUniqueValue());
		var holidays_us = holidays?.filter(h => h.region == 'US');
		var holidays_idc = holidays?.filter(h => h.region == 'IDC');
		
		var us_wellness = holidays_us?.filter(h => h.type == 'wellness_day').map(h => h.formatted_date);
		data.us_wellness = us_wellness.join(', ');

		var us_holidays = holidays_us?.filter(h => h.type == 'holiday').map(h => h.formatted_date);
		data.us_holidays = us_holidays.join(', ');

		var idc_wellness = holidays_idc?.filter(h => h.type == 'wellness_day').map(h => h.formatted_date);
		data.idc_wellness = idc_wellness.join(', ');

		var idc_holidays = holidays_idc?.filter(h => h.type == 'holiday').map(h => h.formatted_date);
		data.idc_holidays = idc_holidays.join(', ');

		data.shifts = ocu.getAllShiftsForRotation(rotation.getUniqueValue());
		if(data.shifts?.length < 1){
			data.shifts = ocu.getAllTeams();
		}

		for(let i in data.shifts){
			var curr = data.shifts[i];
			curr.shiftForm = $sp.getForm(constants.TABLE_SHIFTS, curr.shift_id);
			curr.shiftView = curr.shiftForm._view;
			curr.shiftModel = curr.shiftForm._fields;
			if(curr.shiftModel.team_member){
				curr.userForm = $sp.getForm('sys_user',curr.user);
				curr.userView = curr.userForm._view;
				curr.userModel = curr.userForm._fields;
			}
			data.shifts[i] = curr;
			console.log(data.shifts[i])
		}
	} else {
		data.admin_errors.push({error:'rotation',msg:'No rotation found'});
	}
	

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>aaron.brunet</sys_created_by>
        <sys_created_on>2024-07-17 00:36:13</sys_created_on>
        <sys_id>3e3f83b393534210bef6fff56aba10b0</sys_id>
        <sys_mod_count>215</sys_mod_count>
        <sys_name>On Call Schedule - Week</sys_name>
        <sys_package display_value="On-Call Schedule" source="x_snc_on_call_sc_0">549b056793db4210bef6fff56aba1057</sys_package>
        <sys_policy/>
        <sys_scope display_value="On-Call Schedule">549b056793db4210bef6fff56aba1057</sys_scope>
        <sys_update_name>sp_widget_3e3f83b393534210bef6fff56aba10b0</sys_update_name>
        <sys_updated_by>aaron.brunet</sys_updated_by>
        <sys_updated_on>2024-08-11 00:57:18</sys_updated_on>
        <template><![CDATA[<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.js"></script>
<div class="schedule-body">
  <h1>UX Component On-Call Rotation</h1>
  <div ng-if="!data.rotation.rotation">
    <h1>No On-Call rotation schedule</h1>
  </div>

    <div ng-if="data.rotation.rotation" id="schedule">
      <div class="schedule-row">
        <h3>Week of {{data.rotation.rotation}}</h3>
      </div>
      <div class="schedule-row">
        <a role="button" class="btn btn-primary" href="?id=oc_list&table={{data.constants.TABLE_ROTATIONS}}&filter=to%3E%3Djavascript:gs.beginningOfToday()%5Eactive%3Dtrue&view=sp&o=from&link=oc_rotation">All Upcoming Rotations</a>
        <button id="convert" ng-click="generateImg('readonly_table')" class="btn btn-primary">
        Save Screenshot
        </button>
      </div>
      <table>
        <tbody>
          <tr class="title-row">
            <th colspan="2">{{options.title}}{{data.rotation.rotation}}</th>
            <th>Phone</th>
          </tr>
          <tr class="manager-row"> 
            <th>US Manager</th>
            <td ng-if="!data.us_manager">No manager scheduled</td>
            <td ng-if="!data.us_manager"></td>

            <td ng-if="data.us_manager">
                  <sp-editable-field 
                    editable-by-user="true" 
                    table={{data.constants.TABLE_SHIFTS}} 
                    table-id="data.us_manager.shift_id" 
                    field-model="data.us_manager.shiftModel.team_member">
                </sp-editable-field>
            </td>
            <td ng-if="data.us_manager">
                <sp-editable-field 
                    editable-by-user="true" 
                    table="sys_user" 
                    table-id="data.us_manager.user" 
                    field-model="data.us_manager.userModel.phone">
              </sp-editable-field>   
            </td>
          </tr>
          <tr class="manager-row"> 
            <th>IDC Manager</th>
            <td ng-if="!data.idc_manager">No manager scheduled</td>
            <td ng-if="!data.idc_manager"></td>
            <td ng-if="data.idc_manager">
                <sp-editable-field 
                    editable-by-user="true" 
                    table={{data.constants.TABLE_SHIFTS}} 
                    table-id="data.idc_manager.shift_id" 
                    field-model="data.idc_manager.shiftModel.team_member">
              </sp-editable-field>
            </td>
            <td ng-if="data.idc_manager">
                <sp-editable-field 
                    editable-by-user="true" 
                    table="sys_user" 
                    table-id="data.idc_manager.user" 
                    field-model="data.idc_manager.userModel.phone">
              </sp-editable-field>   
            </td>
          </tr>
          <tr ng-repeat="shift in data.shifts" class="team-row">
            <th><a href="?id=oc_manage_team&sys_id={{shift.team_id}}" target="_blank">{{shift.team}}</a></th>
            <!--<td ng-if="!shift.name">No engineer scheduled</td>-->
            <td>
              <sp-editable-field 
                    editable-by-user="true" 
                    table={{data.constants.TABLE_SHIFTS}} 
                    table-id="shift.shift_id" 
                    field-model="shift.shiftModel.team_member">
              </sp-editable-field>
            </td>
            <td>
              <sp-editable-field 
                    editable-by-user="true" 
                    table="sys_user" 
                    table-id="shift.user" 
                    field-model="shift.userModel.phone">
              </sp-editable-field>    
              <span ng-if="!shift.phone && !editable">No phone #</span>
            </td>
          </tr>
          <tr class="holiday-row">
            <th>US Wellness Day</th>
            <td colspan="2">{{data.us_wellness || 'None'}}</td>
          </tr>
          <tr class="holiday-row">
            <th>US Holidays</th>
            <td colspan="2">{{data.us_holidays || 'None'}}</td>
          </tr>
          <tr class="holiday-row">
            <th>IDC Wellness Day</th>
            <td colspan="2">{{data.idc_wellness || 'None'}}</td>
          </tr>
          <tr class="holiday-row">
            <th>IDC Holidays</th>
            <td colspan="2">{{data.idc_holidays || 'None'}}</td>
          </tr>
          </tbody>
        </table>
    </div>
  <div id="markdown_table">
    <pre>
    POST /hooks/xxx-generatedkey-xxx HTTP/1.1
    Host: mattermost.service-now.com
    Content-Type: application/json
    {
      "channel": "_P1_CHANNEL_",
      "username": "_P1_CHANNEL_USER_",
      "icon_url": "_ICON_",
      "text": "{{data.mk_table}}"
    }
	</pre>
  </div>
  <div id="readonly_table">
  </div>
  
</div>
      <div id="result">
      </div>




<!--<script type="text/javascript" src="https://github.com/niklasvh/html2canvas/releases/download/0.5.0-alpha1/html2canvas.js"></script>-->
]]></template>
    </sp_widget>
    <sys_es_latest_script action="INSERT_OR_UPDATE">
        <id>3e3f83b393534210bef6fff56aba10b0</id>
        <sys_created_by>aaron.brunet</sys_created_by>
        <sys_created_on>2024-07-17 00:36:13</sys_created_on>
        <sys_id>7dafc3b393534210bef6fff56aba1018</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>aaron.brunet</sys_updated_by>
        <sys_updated_on>2024-07-17 00:36:13</sys_updated_on>
        <table>sp_widget</table>
        <use_es_latest>true</use_es_latest>
    </sys_es_latest_script>
</record_update>
