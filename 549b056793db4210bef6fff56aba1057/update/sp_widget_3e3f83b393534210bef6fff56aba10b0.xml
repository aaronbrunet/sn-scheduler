<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller=function(spUtil,$scope) {
  /* widget controller */
  var c = this;

  spUtil.recordWatch($scope, $scope.data.constants.TABLE_SHIFTS, "rotation=" + $scope.data.rotation.id, function(record){
	console.log(record);
			spUtil.update($scope);//.then(function(){});
   });


};]]></client_script>
        <controller_as>c</controller_as>
        <css>table {&#13;
	border: 1px solid grey;&#13;
  	padding: 2rem;&#13;
  width: 60%;&#13;
  border-radius: 20%;&#13;
} &#13;
tr {&#13;
	padding: 1rem;&#13;
}&#13;
td,th {&#13;
	border: 1px solid grey;&#13;
  padding: 1rem;&#13;
  width: 33%;&#13;
}&#13;
&#13;
th, .holiday-row {&#13;
	background-color: #e2f5ff;&#13;
}&#13;
&#13;
tr.team-row {&#13;
  th { background-color: #ffd289; }&#13;
}&#13;
tr.title-row {&#13;
  th,td { background-color: #fff08f; }&#13;
}&#13;
tr.manager-row{&#13;
  th { background-color:#a2d0e9; }&#13;
  td { background-color:#e2f5ff; }&#13;
}&#13;
&#13;
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>on-call-schedule-week</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>On Call Schedule - Week</name>
        <option_schema>[{"displayValue":"On-Call Rotation","name":"rotation","section":"Data","label":"Rotation","type":"reference","value":"x_snc_on_call_sc_0_on_call_rotation","ed":{"reference":"x_snc_on_call_sc_0_on_call_rotation"}},{"name":"title","section":"Presentation","label":"Title","type":"string"}]</option_schema>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
  /* populate the 'data' object */
  /* e.g., data.table = $sp.getValue('table'); */
	var ocu = new x_snc_on_call_sc_0.OnCallUtils();
	var constants = ocu.getConstants();
	data.constants = constants;

	
	var rotation = new GlideRecord(constants.TABLE_ROTATIONS);
	if(input && input?.rotation !=''){
		console.log(['input',input.rotation]);
		rotation.get(input.rotation.id);
	} else if(options?.rotation) {
		console.log(['options',options?.rotation]);
		rotation.get(options?.rotation);
	} else if($sp.getParameter('sys_id')) {
		console.log(['url',$sp.getParameter('sys_id')]);
		rotation.get($sp.getParameter('sys_id'));
	} else {
		rotation.get(ocu.getRotation());
	}
	data.rotation = {
		id:rotation.getUniqueValue(),
		rotation:rotation.getDisplayValue('rotation'),
		from:rotation.getDisplayValue('from'),
		to:rotation.getDisplayValue('to')
	};

	var managers = ocu.getManagersByRotation(rotation.getUniqueValue());
	for(let i in managers) {
		managers[i].shiftForm = $sp.getForm(constants.TABLE_SHIFTS, managers[i].shift_id);
		managers[i].shiftModel = managers[i].shiftForm._fields;
		managers[i].userForm = $sp.getForm('sys_user',managers[i].user);
		managers[i].userModel = managers[i].userForm._fields;
	}
	console.log(managers);

	data.us_manager = managers.find(m => m.region == 'US');
	data.idc_manager = managers.find(m => m.region == 'IDC');

	var now_manager = ocu.getManagersByDate();

	var holidays = ocu.getAllHolidaysForRotation(rotation.getUniqueValue());
	var holidays_us = holidays?.filter(h => h.region == 'US');
	var holidays_idc = holidays?.filter(h => h.region == 'IDC');
	
	var us_wellness = holidays_us?.filter(h => h.type == 'wellness_day').map(h => h.formatted_date);
	data.us_wellness = us_wellness.join(', ');

	var us_holidays = holidays_us?.filter(h => h.type == 'holiday').map(h => h.formatted_date);
	data.us_holidays = us_holidays.join(', ');

	var idc_wellness = holidays_idc?.filter(h => h.type == 'wellness_day').map(h => h.formatted_date);
	data.idc_wellness = idc_wellness.join(', ');

	var idc_holidays = holidays_idc?.filter(h => h.type == 'holiday').map(h => h.formatted_date);
	data.idc_holidays = idc_holidays.join(', ');

	data.shifts = ocu.getAllShiftsForRotation(rotation.getUniqueValue());
	if(data.shifts?.length < 1){
		data.shifts = ocu.getAllTeams();
	}

	for(let i in data.shifts){
		var curr = data.shifts[i];
		curr.shiftForm = $sp.getForm(constants.TABLE_SHIFTS, curr.shift_id);
		curr.shiftView = curr.shiftForm._view;
		curr.shiftModel = curr.shiftForm._fields;
		if(curr.shiftModel.team_member){
			curr.userForm = $sp.getForm('sys_user',curr.user);
			curr.userView = curr.userForm._view;
			curr.userModel = curr.userForm._fields;
		}
		data.shifts[i] = curr;
		console.log(data.shifts[i])
	}

	
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>aaron.brunet</sys_created_by>
        <sys_created_on>2024-07-17 00:36:13</sys_created_on>
        <sys_id>3e3f83b393534210bef6fff56aba10b0</sys_id>
        <sys_mod_count>113</sys_mod_count>
        <sys_name>On Call Schedule - Week</sys_name>
        <sys_package display_value="On-Call Schedule" source="x_snc_on_call_sc_0">549b056793db4210bef6fff56aba1057</sys_package>
        <sys_policy/>
        <sys_scope display_value="On-Call Schedule">549b056793db4210bef6fff56aba1057</sys_scope>
        <sys_update_name>sp_widget_3e3f83b393534210bef6fff56aba10b0</sys_update_name>
        <sys_updated_by>aaron.brunet</sys_updated_by>
        <sys_updated_on>2024-07-19 00:58:06</sys_updated_on>
        <template><![CDATA[<div ng-if="!data.rotation.rotation">
  <h1>No On-Call rotation schedule</h1>
</div>
<div ng-if="data.rotation.rotation">
  <h1>UX Component On-Call Schedule</h1>
  <table>
	<tbody>
      <tr class="title-row">
        <th colspan="2">{{options.title}}{{data.rotation.rotation}}</th>
        <th>Phone</th>
      </tr>
      <tr class="manager-row"> 
        <th>US Manager</th>
        <td ng-if="!data.us_manager">No manager scheduled</td>
        <td ng-if="!data.us_manager"></td>
        <td>
        	<sp-editable-field 
				editable-by-user="true" 
				table={{data.constants.TABLE_SHIFTS}} 
                table-id="data.us_manager.shift_id" 
                field-model="data.us_manager.shiftModel.team_member">
          </sp-editable-field>
        </td>
        <td>
        	<sp-editable-field 
                editable-by-user="true" 
                table="sys_user" 
                table-id="data.us_manager.user" 
                field-model="data.us_manager.userModel.phone">
          </sp-editable-field>   
        </td>
      </tr>
      <tr class="manager-row"> 
        <th>IDC Manager</th>
        <td ng-if="!data.idc_manager">No manager scheduled</td>
        <td ng-if="!data.idc_manager"></td>
        <td ng-if="data.idc_manager">
        	<sp-editable-field 
				editable-by-user="true" 
				table={{data.constants.TABLE_SHIFTS}} 
                table-id="data.idc_manager.shift_id" 
                field-model="data.idc_manager.shiftModel.team_member">
          </sp-editable-field>
        </td>
        <td ng-if="data.idc_manager">
        	<sp-editable-field 
                editable-by-user="true" 
                table="sys_user" 
                table-id="data.idc_manager.user" 
                field-model="data.idc_manager.userModel.phone">
          </sp-editable-field>   
        </td>
      </tr>
	  <tr ng-repeat="shift in data.shifts" class="team-row">
        <th>{{shift.team}}</th>
        <!--<td ng-if="!shift.name">No engineer scheduled</td>-->
        <td>
          <sp-editable-field 
				editable-by-user="true" 
				table={{data.constants.TABLE_SHIFTS}} 
                table-id="shift.shift_id" 
                field-model="shift.shiftModel.team_member">
          </sp-editable-field>
        </td>
		<td>
          <sp-editable-field 
                editable-by-user="true" 
                table="sys_user" 
                table-id="shift.user" 
                field-model="shift.userModel.phone">
          </sp-editable-field>    
		  <span ng-if="!shift.phone && !editable">No phone #</span>
        </td>
      </tr>
      <tr class="holiday-row">
        <th>US Wellness Day</th>
        <td colspan="2">{{data.us_wellness || 'None'}}</td>
      </tr>
      <tr class="holiday-row">
        <th>US Holidays</th>
        <td colspan="2">{{data.us_holidays || 'None'}}</td>
      </tr>
      <tr class="holiday-row">
        <th>IDC Wellness Day</th>
        <td colspan="2">{{data.idc_wellness || 'None'}}</td>
      </tr>
      <tr class="holiday-row">
        <th>IDC Holidays</th>
        <td colspan="2">{{data.idc_holidays || 'None'}}</td>
      </tr>
      </tbody>
    </table>
</div>]]></template>
    </sp_widget>
    <sys_es_latest_script action="INSERT_OR_UPDATE">
        <id>3e3f83b393534210bef6fff56aba10b0</id>
        <sys_created_by>aaron.brunet</sys_created_by>
        <sys_created_on>2024-07-17 00:36:13</sys_created_on>
        <sys_id>7dafc3b393534210bef6fff56aba1018</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>aaron.brunet</sys_updated_by>
        <sys_updated_on>2024-07-17 00:36:13</sys_updated_on>
        <table>sp_widget</table>
        <use_es_latest>true</use_es_latest>
    </sys_es_latest_script>
</record_update>
