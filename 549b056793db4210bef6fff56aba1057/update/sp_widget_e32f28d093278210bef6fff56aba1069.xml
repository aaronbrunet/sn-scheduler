<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller=function(spUtil,$scope,spAriaFocusManager,$location) {
  /* widget controller */
  var c = this;

  spUtil.recordWatch($scope, $scope.data.constants.TABLE_TEAM_MEMBERS, "team=" + $scope.data.team_id);

  $scope.$on('data_table.click', function(e, parms){
	console.log([e,parms]);
	var p = $scope.data.page_id || 'oc_form';
	var s = {id: p, table: parms.table, sys_id: parms.sys_id, view: 'sp'};
	var newURL = $location.search(s);
	spAriaFocusManager.navigateToLink(newURL.url());
	});



};]]></client_script>
        <controller_as>c</controller_as>
        <css>table.oc-table {&#13;
	border: 1px solid grey;&#13;
  	padding: 2rem;&#13;
  width: 60%;&#13;
  border-radius: 20%;&#13;
&#13;
  tr {&#13;
      padding: 1rem;&#13;
  }&#13;
  td, th {&#13;
      border: 1px solid grey;&#13;
    padding: 1rem;&#13;
    width: 33%;&#13;
  }&#13;
  tr.manager-row{&#13;
    th { background-color:#a2d0e9; }&#13;
    td { background-color:#e2f5ff; }&#13;
  }&#13;
}&#13;
&#13;
.title-row {&#13;
	display: flex;&#13;
    flex-direction: row;&#13;
    align-items: center;&#13;
}&#13;
.title-col {&#13;
	display: inline-block;&#13;
  	margin: 1rem .5rem;&#13;
    h1,h2 {&#13;
    	margin-top: 1rem !important;&#13;
    }&#13;
}&#13;
&#13;
.list-block {&#13;
	padding: 2rem 0;&#13;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>on-call-team</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>On Call Schedule - Manage Team</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
	//console.log(gs.getUserID());
	var ocu = new x_snc_on_call_sc_0.OnCallUtils();
	var constants = ocu.getConstants();
	data.constants = constants;

	var team_id = '-1';

	if($sp.getParameter('team')){
		team_id = $sp.getParameter('team');
	} else {
		team_id = ocu.getTeamFromUser(gs.getUserID());
		console.log('Getting team from user: '+team_id);
	}


	var team = new GlideRecord(constants.TABLE_TEAMS);
	team.get(team_id);
	var team_roster = ocu.buildTeamRoster(team_id);
	//console.log(team_roster);
	data.team_roster = team_roster;
	data.team = team.getDisplayValue();

	for(var i in data.team_roster){
		var curr = data.team_roster[i];
		curr.tmForm = $sp.getForm(constants.TABLE_TEAM_MEMBERS, curr.id);
		curr.tmView = curr.tmForm._view;
		curr.tmModel = curr.tmForm._fields;
		if(curr.tmModel["user.phone"]){
			curr.userForm = $sp.getForm('sys_user',curr.user);
			curr.userView = curr.userForm._view;
			curr.userModel = curr.userForm._fields;
		}
		data.team_roster[i] = curr;
	}
	data.mgr_roster = data.team_roster?.filter(m => m.role == 'Manager');
	data.team_roster = data.team_roster?.filter(m => m.role != 'Manager');
	//console.log(data.team_roster);

	var gtl = {};
	gtl.options = {};
	gtl.options.title = 'All Teams';
	var gtl_table = new GlideRecord('sys_db_object');
	gtl_table.get('name',data.constants.TABLE_TEAMS);
	gtl.options.table = gtl_table.getValue('sys_id');
	gtl.options.filter = 'active=true';
	gtl.options.params = '&o=group';
	data.gtlWidget = $sp.getWidget('oc-go-to-list-btn', gtl.options);

	var trl = {};
	trl.options = {};
	trl.options.table = data.constants.TABLE_TEAM_MEMBERS;
	trl.options.fields = 'user,user.phone,region,role,order';//data.field_list;
	trl.options.column_labels = {
		role: "Role",
		region: "Region",
		user: "Name",
		"user.phone": "Phone"
	};
	trl.options.o = 'order';
	trl.options.d = 'asc';
	trl.options.filter = 'active=true^assignment_group='+team_id;
	trl.options.useInstanceTitle = true; // to make sure Data Table widget uses headerTitle always
	trl.options.show_breadcrumbs=false;
	data.trlWidget = $sp.getWidget('widget-data-table', trl.options);

//id=form&table=x_snc_on_call_sc_0_on_call_shift&sys_id=458d360093af4210bef6fff56aba10dd&view=sp

	
	var esl = {};
	esl.options = {};
	esl.options.table = data.constants.TABLE_SHIFTS;
	esl.options.fields = 'rotation,from,team_member';
	esl.options.filter = 'team='+team_id+'^type=^ORtype=engineer^rotation.to>=javascript:gs.beginningOfToday()';
	//esl.options.sp_page = sp_page;
	esl.options.sp_page = 'oc_form';
	esl.options.sp_page_dv = 'oc_form';
	esl.page_id = esl.options.page_id;
	esl.options.show_breadcrumbs=false;
	esl.options.useInstanceTitle = true;
	esl.options.headerTitle = 'Engineer On-Call Shifts';
	esl.options.sys_class_name = "sp_instance_table";
	data.eslWidget = $sp.getWidget('widget-data-table',esl.options);
	
	var msl = {};
	msl.options = {};
	msl.options.table = data.constants.TABLE_SHIFTS;
	msl.options.fields = 'rotation,from,team_member';
	msl.options.filter = 'team='+team_id+'^type=manager^rotation.to>=javascript:gs.beginningOfToday()';
	msl.options.show_breadcrumbs=false;
	msl.options.useInstanceTitle = true;
	msl.options.headerTitle = 'Manager On-Call Shifts';
	data.mslWidget = $sp.getWidget('widget-data-table',msl.options);

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>aaron.brunet</sys_created_by>
        <sys_created_on>2024-07-18 02:13:09</sys_created_on>
        <sys_id>e32f28d093278210bef6fff56aba1069</sys_id>
        <sys_mod_count>112</sys_mod_count>
        <sys_name>On Call Schedule - Manage Team</sys_name>
        <sys_package display_value="On-Call Schedule" source="x_snc_on_call_sc_0">549b056793db4210bef6fff56aba1057</sys_package>
        <sys_policy/>
        <sys_scope display_value="On-Call Schedule">549b056793db4210bef6fff56aba1057</sys_scope>
        <sys_update_name>sp_widget_e32f28d093278210bef6fff56aba1069</sys_update_name>
        <sys_updated_by>aaron.brunet</sys_updated_by>
        <sys_updated_on>2024-08-13 00:10:15</sys_updated_on>
        <template><![CDATA[<div>
  <div class="title-row">
    <div class="title-col"><h1>{{data.team}}</h1></div>
    <div class="title-col"><sp-widget widget="data.gtlWidget"></sp-widget></div>
  </div>
  <div ng-if="data.mgr_roster">
    <h2>Managers</h2>
    <div ng-repeat="m in data.mgr_roster">
      <h4><a href="?id=oc_form&table={{data.constants.TABLE_TEAM_MEMBERS}}&sys_id={{m.id}}&view=sp">{{m.name}} ({{m.region}})</a></h4>
    </div>
  </div>
  
  <div ng-if="data.team_roster">
    <div class="title-row">
	  <div class="title-col"><h2>Team Roster</h2></div>
      <div class="title-col"><a role="button" href="?id=sc_cat_item&sys_id=c6d0cae887cc5a104c1fc99d0ebb3510&sysparm_category=07e04ee887cc5a104c1fc99d0ebb3500" class="btn btn-primary">Update Team Members</a></div>
    </div>
    <div class="list-block">
	    <sp-widget widget="data.trlWidget"></sp-widget>
    </div>
    
    <!--
    <table class="oc-table">
      <tr>
        <th>Name</th><th>Phone</th><th>Region</th><th>Role</th>
      </tr>
      <tr ng-repeat="m in data.mgr_roster" class="manager-row">
        <td><a href="?id=oc_form&table={{data.constants.TABLE_TEAM_MEMBERS}}&sys_id={{m.id}}" target="_blank">{{m.name}}</a></td>
        <td><sp-editable-field editable-by-user="true" table="sys_user" table-id="m.user" field-model="m.userModel.phone"></sp-editable-field></td>
        <td>{{m.region}}</td>
        <td>{{m.role}}</td>
      </tr>
    <tr ng-repeat="m in data.team_roster">
      <td><a href="?id=oc_form&table={{data.constants.TABLE_TEAM_MEMBERS}}&sys_id={{m.id}}" target="_blank">{{m.name}}</a></td>
      <td><sp-editable-field editable-by-user="true" table="sys_user" table-id="m.user" field-model="m.userModel.phone"></sp-editable-field></td>
      <td>{{m.region}}</td>
      <td>{{m.role}}</td>
    </tr>
  </table>
-->
  <h2>Team On-Call Shifts</h2>
  <div class="list-block">
    <sp-widget widget="data.eslWidget"></sp-widget>
    <button class="btn btn-primary">Update Shifts</button>
  </div>
  <div class="list-block">
  	<sp-widget widget="data.mslWidget"></sp-widget>
    <button class="btn btn-primary">Update Manager Shifts</button>
  </div>

  
</div>]]></template>
    </sp_widget>
    <sys_es_latest_script action="INSERT_OR_UPDATE">
        <id>e32f28d093278210bef6fff56aba1069</id>
        <sys_created_by>aaron.brunet</sys_created_by>
        <sys_created_on>2024-07-18 02:13:09</sys_created_on>
        <sys_id>df6f60d093278210bef6fff56aba10ea</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>aaron.brunet</sys_updated_by>
        <sys_updated_on>2024-07-18 02:13:09</sys_updated_on>
        <table>sp_widget</table>
        <use_es_latest>true</use_es_latest>
    </sys_es_latest_script>
</record_update>
